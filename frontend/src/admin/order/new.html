<div class="admin-order-new">
  <page-property name="title" value="Ny ordre"></page-property>

  <div class="page-header">
    <h1>
      <span class="eventgroup">
        <a routerLink="/a/eventgroup/{{ ctrl.eventgroup.id }}">{{
          ctrl.eventgroup.title
        }}</a>
      </span>
      Ny ordre

      <span class="pull-right">
        <a
          class="btn btn-default"
          routerLink="/a/orders"
          [queryParams]="{ eventgroup_id: ctrl.eventgroup.id }"
          >Ordreliste</a
        >
      </span>
    </h1>
  </div>

  <div>
    <div class="row">
      <div class="col-md-6">
        <h2>Ordredetaljer</h2>

        <form
          class="form-horizontal"
          (ngSubmit)="!form.$valid || ctrl.completeOrder()"
          name="form"
        >
          @if (ctrl.order.id) {
            <div class="form-group">
              <label class="text-right col-sm-4">Ordrenr</label>
              <div class="col-sm-8">{{ ctrl.order.order_text_id }}</div>
            </div>
          }
          <div class="form-group" form-input-check="form,username">
            <label class="control-label col-sm-4">Fullt navn</label>
            <div class="col-sm-8">
              <input
                type="text"
                name="username"
                [(ngModel)]="ctrl.order.name"
                class="form-control"
                placeholder="(valgfritt)"
                focus-on="namefocus"
              />
            </div>
          </div>
          <div class="form-group" form-input-check="form,email">
            <label class="control-label col-sm-4">E-postadresse</label>
            <div class="col-sm-8">
              <input
                type="email"
                name="email"
                [(ngModel)]="ctrl.order.email"
                class="form-control"
                placeholder="(valgfritt)"
              />
              <span class="help-block"
                >Vi sender kopi av ordre hvis e-post fylles ut</span
              >
            </div>
          </div>
          <div class="form-group" form-input-check="form,phone">
            <label class="control-label col-sm-4">Telefonnummer</label>
            <div class="col-sm-8">
              <input
                type="tel"
                name="phone"
                [(ngModel)]="ctrl.order.phone"
                class="form-control"
                ng-pattern="/^\+?\d+$/"
                placeholder="(valgfritt)"
              />
            </div>
          </div>
          <div class="form-group" form-input-check="form,recruiter">
            <label class="control-label col-sm-4">Evt. vervet av</label>
            <div class="col-sm-8">
              <input
                type="tel"
                name="recruiter"
                [(ngModel)]="ctrl.order.recruiter"
                class="form-control"
                placeholder="(valgfritt)"
              />
              <span class="help-block"
                >Navn på beboer ved Blindern Studenterhjem</span
              >
            </div>
          </div>
          <div class="form-group">
            <label for="comment" class="col-sm-4 control-label"
              >Kommentar</label
            >
            <div class="col-sm-8">
              <textarea
                class="form-control"
                [(ngModel)]="ctrl.order.comment"
                id="comment"
                rows="3"
                placeholder="(valgfritt)"
              ></textarea>
              <span class="help-block"
                >Kommentar er ikke synlig for kunden.</span
              >
            </div>
          </div>
          <div class="form-group">
            <label class="text-right col-sm-4">Totalt å betale</label>
            <div class="col-sm-8">
              <b>{{ ctrl.total | price: true }}</b>
            </div>
          </div>
          @if (ctrl.order.tickets && ctrl.order.tickets.length > 0) {
            <div class="form-group">
              <label class="col-sm-4 control-label" for="printer"
                >Skriv ut billetter</label
              >
              <div class="col-sm-8">
                <printer-list
                  id="printer"
                  printer="ctrl.printer"
                  can-disable="true"
                ></printer-list>
              </div>
            </div>
          }

          @if (ctrl.order.tickets && ctrl.order.tickets.length > 0) {
            <div class="form-group">
              <label class="col-sm-4 control-label" for="paymentgroup"
                >Oppgjør</label
              >
              <div class="col-sm-8">
                <paymentgroup-select
                  eventgroup-id="ctrl.eventgroup.id"
                  paymentgroup="ctrl.paymentgroup"
                  id="paymentgroup"
                ></paymentgroup-select>
              </div>
            </div>
          }

          <div class="row">
            <div class="col-sm-offset-4 col-sm-8">
              @if (ctrl.order.id) {
                <div>
                  @if (ctrl.order.tickets && ctrl.order.tickets.length > 0) {
                    <input
                      class="btn btn-success"
                      type="submit"
                      value="Marker som betalt"
                      ng-disabled="!ctrl.paymentgroup"
                    />
                  }
                  <input
                    class="btn btn-default"
                    type="button"
                    value="Lagre reservasjon"
                    (click)="ctrl.saveOrder()"
                  />
                  <input
                    class="btn btn-danger"
                    type="button"
                    value="Slett"
                    (click)="ctrl.abortOrder()"
                  />
                </div>
              }
              @if (!ctrl.order.id) {
                <div>
                  <input
                    class="btn btn-primary"
                    type="button"
                    value="Registrer"
                    (click)="ctrl.createBlank()"
                  />
                </div>
              }
            </div>
          </div>
        </form>
      </div>
      <div class="col-md-6">
        <h2>Reserverte billetter</h2>

        @if (!ctrl.ticketgroups) {
          <p>Ingen billetter er reservert.</p>
        }

        @if (ctrl.ticketgroups) {
          <table class="tickets table table-striped table-condensed">
            <thead>
              <tr>
                <th>Arrangement</th>
                <th>Billettgruppe</th>
                <th>Antall</th>
                <th>Sum</th>
                <th>&nbsp;</th>
              </tr>
            </thead>
            <tbody>
              @for (group of ctrl.ticketgroups; track group) {
                <tr>
                  <td>
                    <a routerLink="/a/event/{{ group.event.id }}" target="_blank"
                      >{{
                        group.event.time_start
                          | formatdate: "D. MMM YYYY HH:mm"
                      }}: {{ group.event.title }}</a
                    >
                  </td>
                  <td>{{ group.ticketgroup.title }}</td>
                  <td>{{ group.num }}</td>
                  <td>
                    {{
                      group.num *
                        (group.ticketgroup.price + group.ticketgroup.fee)
                        | price
                    }}
                  </td>
                  <td>
                    <button
                      class="btn btn-sm btn-danger"
                      (click)="ctrl.deleteTicket(group)"
                      title="Slett én reservasjon"
                      ng-disabled="group.working"
                    >
                      @if (!group.working) {
                        <i class="glyphicon glyphicon-remove"></i>
                      }
                      @if (group.working) {
                        <i class="glyphicon glyphicon-cog"></i>
                      }
                    </button>
                  </td>
                </tr>
              }
            </tbody>
            <tfoot>
              <tr>
                <th colspan="2">Sum</th>
                <th>{{ ctrl.order.tickets.length }}</th>
                <th>{{ ctrl.total | price }}</th>
                <th>&nbsp;</th>
              </tr>
            </tfoot>
          </table>
        }

        <a class="btn btn-primary" (click)="ctrl.addTickets()"
          >Legg til{{
            ctrl.order.tickets.length == 0 ? "" : " flere"
          }}
          billetter</a
        >
      </div>
    </div>
  </div>

  <hr />

  <h2>Ordrehistorikk</h2>
  @if (!ctrl.previousOrders) {
    <div>Laster data ...</div>
  }
  @if (ctrl.previousOrders) {
    <div>
      <p>
        Dette er en liste over de siste ordrene opprettet i en billettluke.
        <a routerLink="/a/orders" [queryParams]="{ eventgroup_id: ctrl.eventgroup.id }">Full liste</a>
      </p>

      <table class="table table-striped table-condensed order-list-table">
        <thead>
          <tr>
            <th>Ordre</th>
            <th>Detaljer</th>
            <th>Ordretotal</th>
            <th>Billetter</th>
          </tr>
        </thead>
        <tbody>
          @for (order of ctrl.previousOrders; track order) {
            <tr [ngClass]="{ invalid: !order.is_valid }">
              <td>
                <a routerLink="/a/order/{{ order.id }}">{{::order.order_text_id}}</a
                ><br />
                {{::order.time|formatdate:'dd. DD.MM.YYYY HH:mm'}}
                @if (!order.is_valid) {
                  <span><br />(kun reservasjon)</span>
                }
              </td>
              <td>
                @if (::order.name) {
                  <span class="order-detail">{{::order.name}}</span>
                }
                @if (::order.email) {
                  <span class="order-detail">{{::order.email}}</span>
                }
                @if (::order.phone) {
                  <span class="order-detail">{{::order.phone}}</span>
                }
                @if (::order.recruiter) {
                  <span class="order-detail"
                    >Vervet av: {{::order.recruiter}}</span
                  >
                }
                @if (
                  ::(!order.name && !order.email && !order.phone && !order.recruiter)
                ) {
                  <span class="order-detail"><i>Ingen detaljer</i></span>
                }
              </td>
              <td>
                {{ order.total_valid | price }}
                @if (order.total_reserved) {
                  <span
                    ><br />(reservert: {{ order.total_reserved | price }})</span
                  >
                }
                @if (order.balance != 0) {
                  <span class="unbalance"
                    ><br />(ubalanse: {{ order.balance | price }})</span
                  >
                }
              </td>
              <td>
                <ul>
                  @for (ticket of order.tickets; track ticket) {
                    <li
                      [ngClass]="{
                        reservation: !ticket.is_valid,
                        revoked: ticket.is_revoked,
                      }"
                    >
                      <a
                        [href]="::api('ticket/' + ticket.id + '/pdf')"
                        target="_self"
                        >#{{::ticket.id}}</a
                      >
                      <a routerLink="/a/event/{{ ticket.event.id }}"
                        >{{::ticket.event.title}}
                        ({{::ticket.event.time_start|formatdate:'DD.MM \\k\\l
                  HH'

                        }})</a
                      >
                      ({{::ticket.ticketgroup.title}})
                      {{::(ticket.ticketgroup.price+ticket.ticketgroup.fee)|price:0:true}}
                    </li>
                  }
                </ul>
              </td>
            </tr>
          }
        </tbody>
      </table>
    </div>
  }
</div>
