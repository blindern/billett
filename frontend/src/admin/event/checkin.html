@if (ctrl.event) {
  <div class="admin-event-checkin">
    <page-property
      name="title"
      value="Innsjekking: {{ ctrl.event.title }} ({{
        ctrl.event.time_start | formatdate: 'DD. MMM'
      }})"
    ></page-property>

    <div class="page-header">
      <h1>
        <span class="eventgroup">
          <a routerLink="/a/eventgroup/{{ ctrl.event.eventgroup.id }}">{{
            ctrl.event.eventgroup.title
          }}</a>
        </span>
        <a routerLink="/a/event/{{ ctrl.event.id }}"
          >{{ ctrl.event.title }} ({{
            ctrl.event.time_start
              | formatdate
                : "ddd D. MMM
        YYYY HH.mm"
          }})</a
        >
        <span class="pull-right">
          <button class="btn btn-primary" (click)="ctrl.loadTickets()">
            Last inn hele billettlista
          </button>
          <a
            class="btn btn-default"
            routerLink="/a/orders?eventgroup_id={{ ctrl.event.eventgroup.id }}"
            target="_blank"
            >Avansert ordresøk</a
          >
        </span>
      </h1>
    </div>

    <div class="row">
      <div class="col-sm-5">
        <table class="table table-striped table-condensed ticketgroups">
          <thead>
            <tr>
              <th>Billettgruppe</th>
              <th>
                <abbr title="Ledige">L</abbr> /
                <abbr title="Reservert">R</abbr>
              </th>
              <th>Innsjekkede</th>
            </tr>
          </thead>
          <tbody>
            @for (g of ctrl.event.ticketgroups; track g) {
              <tr>
                <td>
                  #{{ g.id }}
                  <a
                    href="a/event/{{ ctrl.event.id }}/ticketgroup/{{ g.id }}"
                    >{{ g.title }}</a
                  >
                  <abbr title="Pris inkl. avgift">{{
                    g.price + g.fee | price
                  }}</abbr>
                  @if (!g.is_normal) {
                    <span>(teller ikke som normal)</span>
                  }
                </td>
                <td>
                  {{ ctrl.event.ticket_count.groups[g.id].free }} /
                  {{ ctrl.event.ticket_count.groups[g.id].pending }}
                </td>
                <td>
                  {{ ctrl.event.ticket_count.groups[g.id].used }} /
                  {{ ctrl.event.ticket_count.groups[g.id].valid }}
                  ({{
                    ctrl.event.ticket_count.groups[g.id].valid -
                      ctrl.event.ticket_count.groups[g.id].used
                  }}
                  gjenstår)
                </td>
              </tr>
            }
          </tbody>
          <tfoot>
            <tr>
              <th colspan="1">&nbsp;</th>
              <th>
                {{ ctrl.event.ticket_count.totals.free }} /
                {{ ctrl.event.ticket_count.totals.pending }}
              </th>
              <th>
                {{ ctrl.event.ticket_count.totals.used }} /
                <abbr title="Gyldige billetter">{{
                  ctrl.event.ticket_count.totals.valid
                }}</abbr>
                /
                @if (ctrl.event.max_normal_sales) {
                  <span>
                    <abbr title="Billetter lagt ut for salg">{{
                      ctrl.event.max_normal_sales
                    }}</abbr>
                    (<abbr title="Øvre billettbegrensning">{{
                      ctrl.event.max_sales
                    }}</abbr
                    >)
                  </span>
                }
                @if (!ctrl.event.max_normal_sales) {
                  <abbr title="Billetter lagt ut for salg">{{
                    ctrl.event.max_sales
                  }}</abbr>
                }
                <br />
                ({{
                  ctrl.event.ticket_count.totals.valid -
                    ctrl.event.ticket_count.totals.used
                }}
                gjenstår)
              </th>
            </tr>
          </tfoot>
        </table>

        <hr />

        <h3>Siste innsjekkede billetter</h3>
        <p
          [hidden]="!!ctrl.lastUsedTickets &amp;&amp; ctrl.lastUsedTicketsLoading"
        >
          Laster data...
        </p>
        <p
          [hidden]="!ctrl.lastUsedTickets &amp;&amp; ctrl.lastUsedTickets.length == 0 &amp;&amp; !ctrl.lastUsedTicketsLoading"
        >
          Ingen billetter er innsjekket.
        </p>
        <table
          [ngClass]="{ isLoading: ctrl.lastUsedTicketsLoading }"
          class="table table-striped table-condensed ticket-list-table"
          [hidden]="!ctrl.lastUsedTickets &amp;&amp; ctrl.lastUsedTickets.length > 0"
        >
          <thead>
            <tr>
              <th>Ordre</th>
              <th>Billett</th>
            </tr>
          </thead>
          <tbody>
            @for (ticket of ctrl.lastUsedTickets; track ticket) {
              <tr>
                <td>
                  <a
                  routerLink="/a/order/{{ ticket.order.id }}"
                    >{{::ticket.order.order_text_id}}</a
                  ><br />
                  {{::ticket.order.time|formatdate:'dd. DD.MM.YYYY HH:mm'}}

                  @if (::ticket.order.name) {
                    <span class="order-detail">{{::ticket.order.name}}</span>
                  }
                  @if (::ticket.order.email) {
                    <span class="order-detail">{{::ticket.order.email}}</span>
                  }
                  @if (::ticket.order.phone) {
                    <span class="order-detail">{{::ticket.order.phone}}</span>
                  }
                  @if (
                    ::(!ticket.order.name && !ticket.order.email && !ticket.order.phone)
                  ) {
                    <span class="order-detail"><i>Ingen detaljer</i></span>
                  }
                </td>
                <td
                  [ngClass]="{
                    reservation: !ticket.is_valid,
                    revoked: ticket.is_revoked,
                  }"
                >
                  @if (ticket.used) {
                    <div class="checkin-time">
                      Innsjekket {{::ticket.used|formatdate:'HH:mm:ss'}}
                    </div>
                  }
                  <a routerLink="/api/ticket/{{ ticket.id }}/pdf" target="_self"
                    >#{{::ticket.id}}</a
                  >
                  @if (ticket.is_valid && !ticket.is_revoked) {
                    <span>
                      @if (ticket.used) {
                        <span>
                          <button
                            class="btn btn-danger"
                            (click)="ctrl.checkout(ticket)"
                          >
                            Utsjekk
                          </button>
                        </span>
                      }
                      @if (!ticket.used) {
                        <span>
                          <button
                            class="btn btn-success"
                            (click)="ctrl.checkin(ticket)"
                          >
                            Innsjekk
                          </button>
                        </span>
                      }
                    </span>
                  }
                  ({{::ticket.ticketgroup.title}})
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>

      <div class="col-sm-7">
        <div
          [ngClass]="{'alert-success': ctrl.keyticket &amp;&amp; ctrl.keyok &amp;&amp; !ctrl.keyticket.isWorking &amp;&amp; !ctrl.ordersLoading, 'alert-danger': ctrl.keyticket &amp;&amp; !ctrl.keyok &amp;&amp; !ctrl.ordersLoading}"
          class="alert checkin-form"
        >
          <form class="form-horizontal" (ngSubmit)="ctrl.performSearch()">
            <div class="form-group">
              <label class="col-sm-4 control-label">Navn eller strekkode</label>
              <div class="col-sm-8">
                <input
                  class="form-control"
                  type="text"
                  id="keyfield"
                  [(ngModel)]="ctrl.searchinput.name"
                  ng-model-options="{debounce:300}"
                  autofocus=""
                />
              </div>
            </div>
            <div class="form-group">
              <label class="col-sm-4 control-label">E-post</label>
              <div class="col-sm-8">
                <input
                  class="form-control"
                  type="text"
                  [(ngModel)]="ctrl.searchinput.email"
                  ng-model-options="{debounce:300}"
                />
              </div>
            </div>
            <div class="form-group">
              <label class="col-sm-4 control-label">Telefon</label>
              <div class="col-sm-8">
                <input
                  class="form-control"
                  type="text"
                  [(ngModel)]="ctrl.searchinput.phone"
                  ng-model-options="{debounce:300}"
                />
              </div>
            </div>
            <div class="form-group">
              <label class="col-sm-4 control-label">Ordrenr</label>
              <div class="col-sm-8">
                <input
                  class="form-control"
                  type="text"
                  [(ngModel)]="ctrl.searchinput.id"
                  ng-model-options="{debounce:300}"
                />
              </div>
            </div>
            <input type="submit" value="Søk" style="display: none" />
          </form>

          @if (!ctrl.keyticket) {
            <p>
              Ved scanning av strekkode vil billett automatisk bli markert som
              benyttet, dersom mulig.
            </p>
          }

          @if (ctrl.keyticket) {
            <div>
              <h4>Scanning av strekkode</h4>
              @if (ctrl.keyticket.isWorking) {
                <p>Sjekker inn billett...</p>
              }
              @if (!ctrl.keyticket.isWorking) {
                <div>
                  @if (ctrl.keyok) {
                    <p><b>Billetten ble innsjekket</b></p>
                  }
                  @if (!ctrl.keyok) {
                    <p>
                      <b
                        >Billetten kan ikke sjekkes inn. Allerede innsjekket
                        eller ugyldig billett?</b
                      >
                    </p>
                  }
                </div>
              }
            </div>
          }
        </div>

        <!-- resultat etter ordresøk -->
        <div [hidden]="!ctrl.orders || ctrl.ordersLoading">
          <h3>Ordresøk</h3>
          <div class="page-loading" [hidden]="!!ctrl.orders.result">
            Søker...
          </div>

          <div [hidden]="!ctrl.orders.result.length == 0">
            <p class="text-center">Ingen ordrer ble funnet.</p>
          </div>

          <div [hidden]="!ctrl.orders.result.length > 0">
            <table class="table table-striped table-condensed order-list-table">
              <thead>
                <tr>
                  <th>Ordre</th>
                  <th>Billetter</th>
                </tr>
              </thead>
              <tbody>
                @for (order of ctrl.orders.result; track order) {
                  <tr [ngClass]="{ invalid: !order.is_valid }">
                    <td>
                      <a
                        routerLink="/a/order/{{ order.id }}"
                        >{{::order.order_text_id}}</a
                      ><br />
                      {{::order.time|formatdate:'dd. DD.MM.YYYY HH:mm'}}
                      @if (!order.is_valid) {
                        <span><br />(kun reservasjon)</span>
                      }

                      @if (::order.name) {
                        <span class="order-detail">{{::order.name}}</span>
                      }
                      @if (::order.email) {
                        <span class="order-detail">{{::order.email}}</span>
                      }
                      @if (::order.phone) {
                        <span class="order-detail">{{::order.phone}}</span>
                      }
                      @if (::(!order.name && !order.email && !order.phone)) {
                        <span class="order-detail"><i>Ingen detaljer</i></span>
                      }

                      @if (order.balance != 0) {
                        <span class="unbalance"
                          ><br />(ubalanse: {{ order.balance | price }})</span
                        >
                      }
                    </td>
                    <td>
                      <ul>
                        @for (ticket of order.tickets; track ticket) {
                          <li
                            [ngClass]="{
                              reservation: !ticket.is_valid,
                              revoked: ticket.is_revoked,
                              keyresult: ticket.key == ctrl.keysearch,
                            }"
                          >
                            <a
                              routerLink="/api/ticket/{{ ticket.id }}/pdf"
                              target="_self"
                              >#{{::ticket.id}}</a
                            >
                            @if (
                              ticket.event.id == ctrl.event.id &&
                              ticket.is_valid &&
                              !ticket.is_revoked
                            ) {
                              <span>
                                @if (ticket.used) {
                                  <span>
                                    <button
                                      class="btn btn-danger"
                                      (click)="ctrl.checkout(ticket)"
                                    >
                                      Utsjekk
                                    </button>
                                  </span>
                                }
                                @if (!ticket.used) {
                                  <span>
                                    <button
                                      class="btn btn-success"
                                      (click)="ctrl.checkin(ticket)"
                                    >
                                      Innsjekk
                                    </button>
                                  </span>
                                }
                              </span>
                            }
                            @if (ticket.event.id != ctrl.event.id) {
                              <span>
                                @if (ticket.event.id != ctrl.event.id) {
                                  <a routerLink="/a/event/{{ ticket.event.id }}">
                                    {{::ticket.event.title}}
                                    ({{::ticket.event.time_start|formatdate:'DD.MM \\k\\l
                          HH'

                                    }})
                                  </a>
                                }
                              </span>
                            }
                            ({{::ticket.ticketgroup.title}})
                            @if (ticket.key == ctrl.keysearch) {
                              <span><b>(DENNE BLE SØKT OPP)</b></span>
                            }
                          </li>
                        }
                      </ul>
                    </td>
                  </tr>
                }
              </tbody>
            </table>

            <div class="text-center">
              <pagination
                page-active="ctrl.searchinput.page"
                page-total="ctrl.orders.pagination.total"
                page-limit="ctrl.orders.pagination.limit"
              ></pagination>
            </div>
          </div>
        </div>

        <!-- hele billettlisten -->
        <div [hidden]="!ctrl.tickets || ctrl.ticketsLoading">
          <h3>Billettliste</h3>
          <div class="page-loading" [hidden]="!!ctrl.tickets">
            Henter data...
          </div>

          <div [hidden]="!ctrl.tickets.length == 0">
            <p class="text-center">Ingen billetter ble funnet.</p>
          </div>

          <div [hidden]="!ctrl.tickets.length > 0">
            <table
              class="table table-striped table-condensed ticket-list-table"
            >
              <thead>
                <tr>
                  <th>Ordre</th>
                  <th>Billetter</th>
                </tr>
              </thead>
              <tbody>
                @for (order of ctrl.tickets; track order) {
                  <tr [ngClass]="{ invalid: !order.is_valid }">
                    <td>
                      <a
                      routerLink="/a/order/{{ order.id }}"
                        >{{::order.order_text_id}}</a
                      ><br />
                      {{::order.time|formatdate:'dd. DD.MM.YYYY HH:mm'}}
                      @if (!order.is_valid) {
                        <span><br />(kun reservasjon)</span>
                      }

                      @if (::order.name) {
                        <span class="order-detail">{{::order.name}}</span>
                      }
                      @if (::order.email) {
                        <span class="order-detail">{{::order.email}}</span>
                      }
                      @if (::order.phone) {
                        <span class="order-detail">{{::order.phone}}</span>
                      }
                      @if (::(!order.name && !order.email && !order.phone)) {
                        <span class="order-detail"><i>Ingen detaljer</i></span>
                      }

                      @if (order.balance != 0) {
                        <span class="unbalance"
                          ><br />(ubalanse: {{ order.balance | price }})</span
                        >
                      }
                    </td>
                    <td>
                      <ul>
                        @for (ticket of order.tickets; track ticket) {
                          <li
                            [ngClass]="{
                              reservation: !ticket.is_valid,
                              revoked: ticket.is_revoked,
                            }"
                          >
                            <a
                              routerLink="/api/ticket/{{ ticket.id }}/pdf"
                              target="_self"
                              >#{{::ticket.id}}</a
                            >
                            @if (ticket.is_valid && !ticket.is_revoked) {
                              <span>
                                @if (ticket.used) {
                                  <span>
                                    <button
                                      class="btn btn-danger"
                                      (click)="ctrl.checkout(ticket)"
                                    >
                                      Utsjekk
                                    </button>
                                  </span>
                                }
                                @if (!ticket.used) {
                                  <span>
                                    <button
                                      class="btn btn-success"
                                      (click)="ctrl.checkin(ticket)"
                                    >
                                      Innsjekk
                                    </button>
                                  </span>
                                }
                              </span>
                            }
                            ({{::ticket.ticketgroup.title}})
                          </li>
                        }
                      </ul>
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
}
